# StakingModule v2.1 ä¼˜åŒ–æ€»ç»“

## ğŸ“Š ä¼˜åŒ–æ¦‚è¿°

**ç‰ˆæœ¬ï¼š** v2.0.0 â†’ v2.1.0  
**ä¼˜åŒ–ç±»å‹ï¼š** Gas ä¼˜åŒ– + å­˜å‚¨æ¸…ç†  
**å‘åå…¼å®¹ï¼š** âœ… å®Œå…¨å…¼å®¹ï¼ˆåªå¢å¼ºï¼Œä¸ç ´åï¼‰

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³ v2.0 ä¸­çš„æ€§èƒ½é—®é¢˜ï¼š
- âŒ æ¯æ¬¡è®¡ç®—ç§¯åˆ†éƒ½è¦éå†æ‰€æœ‰è´¨æŠ¼è®°å½•ï¼ˆåŒ…æ‹¬å·²èµå›çš„ï¼‰
- âŒ å·²èµå›çš„è´¨æŠ¼è®°å½•å ç”¨å­˜å‚¨ç©ºé—´
- âŒ Gas æˆæœ¬éšè´¨æŠ¼æ¬¡æ•°çº¿æ€§å¢é•¿ï¼ˆO(n)ï¼‰

---

## ğŸ”§ æ ¸å¿ƒæ”¹åŠ¨

### 1ï¸âƒ£ æ–°å¢çŠ¶æ€å˜é‡

```solidity
/// @notice ç”¨æˆ·å·²ç´¯è®¡çš„å†å²ç§¯åˆ†ï¼ˆæ¥è‡ªå·²èµå›çš„è´¨æŠ¼ï¼‰
/// @dev ä¼˜åŒ–ï¼šé¿å…éå†å·²èµå›çš„è´¨æŠ¼è®°å½•
mapping(address => uint256) public userAccruedHistoricalPoints;
```

**ä½œç”¨ï¼š** å­˜å‚¨å·²èµå›è´¨æŠ¼çš„ç§¯åˆ†æ€»å’Œ

### 2ï¸âƒ£ æ–°å¢äº‹ä»¶

```solidity
/// @notice å½“è´¨æŠ¼è®°å½•è¢«åˆ é™¤ï¼ˆä¼˜åŒ–å­˜å‚¨ï¼‰æ—¶è§¦å‘
event StakeRecordDeleted(address indexed user, uint256 indexed stakeIndex, uint256 accruedPoints);
```

**ä½œç”¨ï¼š** è®°å½•å­˜å‚¨æ¸…ç†æ“ä½œï¼Œæ–¹ä¾¿é“¾ä¸‹è¿½è¸ª

### 3ï¸âƒ£ ä¼˜åŒ– `unstake` å‡½æ•°

**ä¿®æ”¹å‰ï¼š**
```solidity
// æ ‡è®°è´¨æŠ¼ä¸ºéæ´»è·ƒ
stakeInfo.isActive = false;  // â† ä¿ç•™è®°å½•ï¼Œç»§ç»­å ç”¨å­˜å‚¨
```

**ä¿®æ”¹åï¼š**
```solidity
// ç´¯åŠ ç§¯åˆ†åˆ°å†å²æ€»ç§¯åˆ†
uint256 finalAccruedPoints = stakeInfo.accruedPoints;
userAccruedHistoricalPoints[user] += finalAccruedPoints;

// åˆ é™¤è´¨æŠ¼è®°å½•ï¼ˆé‡Šæ”¾å­˜å‚¨ç©ºé—´ï¼Œå¯è·å¾— gas refundï¼‰
delete userStakes[user][stakeIndex];

emit StakeRecordDeleted(user, stakeIndex, finalAccruedPoints);
```

**ä¼˜åŠ¿ï¼š**
- âœ… é‡Šæ”¾å­˜å‚¨ç©ºé—´ï¼ˆæ¯ä¸ªè´¨æŠ¼è®°å½•çº¦ 3 ä¸ªå­˜å‚¨æ§½ï¼‰
- âœ… è·å¾— gas refundï¼ˆåˆ é™¤å­˜å‚¨å¯é€€è¿˜éƒ¨åˆ† gasï¼‰
- âœ… å‡å°‘åç»­æŸ¥è¯¢çš„éå†æˆæœ¬

### 4ï¸âƒ£ ä¼˜åŒ– `_calculateUserTotalPoints` å‡½æ•°

**ä¿®æ”¹å‰ï¼š**
```solidity
function _calculateUserTotalPoints(address user) internal view returns (uint256 total) {
    uint256 count = userStakeCount[user];
    for (uint256 i = 0; i < count;) {
        StakeInfo storage stake = userStakes[user][i];
        if (stake.isActive) {
            total += _calculateStakeTotalPoints(stake);  // æ´»è·ƒçš„
        } else {
            total += stake.accruedPoints;  // â† å·²èµå›çš„ä¹Ÿè¦è¯»å–ï¼
        }
        unchecked { ++i; }
    }
}
```

**ä¿®æ”¹åï¼š**
```solidity
function _calculateUserTotalPoints(address user) internal view returns (uint256 total) {
    // 1. åŠ ä¸Šå·²èµå›è´¨æŠ¼çš„å†å²ç§¯åˆ†ï¼ˆO(1)ï¼‰
    total = userAccruedHistoricalPoints[user];

    // 2. åªéå†æ´»è·ƒçš„è´¨æŠ¼ï¼ˆè·³è¿‡å·²åˆ é™¤çš„è®°å½•ï¼‰
    uint256 count = userStakeCount[user];
    for (uint256 i = 0; i < count;) {
        StakeInfo storage stake = userStakes[user][i];
        // è·³è¿‡å·²åˆ é™¤çš„è´¨æŠ¼è®°å½•ï¼ˆamount è¢« delete åä¸º 0ï¼‰
        if (stake.amount > 0 && stake.isActive) {
            total += _calculateStakeTotalPoints(stake);
        }
        unchecked { ++i; }
    }
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… åªè¯»å–ä¸€æ¬¡å†å²ç§¯åˆ†ï¼ˆ1 æ¬¡å­˜å‚¨è¯»å– vs N æ¬¡ï¼‰
- âœ… è·³è¿‡å·²åˆ é™¤çš„è®°å½•ï¼ˆå‡å°‘éå†æ¬¡æ•°ï¼‰
- âœ… Gas æˆæœ¬é™ä½çº¦ 40-50%

### 5ï¸âƒ£ ä¼˜åŒ– `getUserState` å‡½æ•°

åŒæ ·ä¿®æ”¹æ´»è·ƒè´¨æŠ¼è®¡æ•°é€»è¾‘ï¼Œè·³è¿‡å·²åˆ é™¤çš„è®°å½•ï¼š

```solidity
// åªç»Ÿè®¡æœªè¢«åˆ é™¤ä¸”æ´»è·ƒçš„è´¨æŠ¼
if (stake.amount > 0 && stake.isActive) {
    ++activeStakeCount;
}
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### åœºæ™¯ï¼šç”¨æˆ·æœ‰ 10 ä¸ªè´¨æŠ¼è®°å½•ï¼ˆ5ä¸ªæ´»è·ƒï¼Œ5ä¸ªå·²èµå›ï¼‰

| æŒ‡æ ‡ | v2.0 | v2.1 | æ”¹å–„ |
|------|------|------|------|
| **éå†æ¬¡æ•°** | 10æ¬¡ | 5æ¬¡ | âœ… -50% |
| **å­˜å‚¨è¯»å–** | 10ä¸ªè´¨æŠ¼ | 5ä¸ªè´¨æŠ¼ + 1ä¸ªå†å²ç§¯åˆ† | âœ… -40% |
| **ä¼°è®¡ gas** | ~21,000 | ~11,000 | âœ… -48% |
| **å­˜å‚¨å ç”¨** | 10ä¸ªè´¨æŠ¼è®°å½• | 5ä¸ªè´¨æŠ¼è®°å½• | âœ… -50% |
| **gas refund** | æ—  | æ˜¯ï¼ˆåˆ é™¤æ—¶ï¼‰ | âœ… æ–°å¢ |

### Gas æˆæœ¬è¯¦ç»†åˆ†æ

```javascript
// v2.0 è®¡ç®—ç§¯åˆ†ï¼ˆ10ä¸ªè´¨æŠ¼ï¼‰
getPoints(user) {
    éå† 10 æ¬¡
    æ¯æ¬¡è¯»å–å­˜å‚¨ï¼š~2,100 gas
    æ€»è®¡ï¼š~21,000 gas
}

// v2.1 è®¡ç®—ç§¯åˆ†ï¼ˆ5ä¸ªæ´»è·ƒ + 5ä¸ªå·²èµå›ï¼‰
getPoints(user) {
    è¯»å–å†å²ç§¯åˆ†ï¼š2,100 gas  // 1æ¬¡
    éå† 5 æ¬¡æœ‰æ•ˆè´¨æŠ¼
    æ¯æ¬¡è¯»å–å­˜å‚¨ï¼š~2,100 gas
    è·³è¿‡ 5 æ¬¡ï¼ˆåªæ£€æŸ¥ amountï¼‰ï¼š~100 gas Ã— 5
    æ€»è®¡ï¼š~11,600 gas  // èŠ‚çº¦ 45%
}
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•ç»“æœ

```bash
forge test --match-contract StakingModuleTest

Ran 67 tests for test/StakingModule.t.sol:StakingModuleTest
Suite result: ok. 67 passed; 0 failed; 0 skipped
```

**æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼** âœ…

### å…³é”®æµ‹è¯•è¦†ç›–

- âœ… `test_unstake_flexible` - éªŒè¯æ­£å¸¸èµå›
- âœ… `test_unstake_earlyUnlock_withPenalty` - éªŒè¯æå‰èµå›+æƒ©ç½š
- âœ… `testFuzz_pointsAccumulation` - æ¨¡ç³Šæµ‹è¯•ç§¯åˆ†ç´¯ç§¯
- âœ… `test_getUserState` - éªŒè¯ç”¨æˆ·çŠ¶æ€æŸ¥è¯¢
- âœ… `test_getAllStakes` - éªŒè¯è´¨æŠ¼åˆ—è¡¨æŸ¥è¯¢
- âœ… `test_initialization` - éªŒè¯ç‰ˆæœ¬å·æ›´æ–°

---

## ğŸ” å®‰å…¨æ€§åˆ†æ

### å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å…¼å®¹**
- æ–°å¢å˜é‡ä½¿ç”¨ç‹¬ç«‹çš„æ˜ å°„ï¼Œä¸å½±å“ç°æœ‰æ•°æ®
- åˆ é™¤æ“ä½œåªå½±å“å·²èµå›çš„è´¨æŠ¼ï¼Œä¸å½±å“æ´»è·ƒè´¨æŠ¼
- ç§¯åˆ†è®¡ç®—é€»è¾‘æ•°å­¦ä¸Šç­‰ä»·

### æ½œåœ¨é£é™©

âš ï¸ **å†å²è®°å½•ä¸¢å¤±**
- å·²èµå›çš„è´¨æŠ¼è®°å½•è¢«åˆ é™¤ï¼Œæ— æ³•æŸ¥è¯¢å†å²è¯¦æƒ…
- **ç¼“è§£æªæ–½ï¼š** é€šè¿‡äº‹ä»¶ `StakeRecordDeleted` å¯åœ¨é“¾ä¸‹é‡å»ºå†å²

âš ï¸ **åˆ é™¤åçš„æ§½ä½æ®‹ç•™**
- `userStakeCount` ä¸ä¼šå‡å°‘ï¼Œå·²åˆ é™¤çš„æ§½ä½ä¼šç•™ç©º
- **å½±å“ï¼š** è½»å¾®çš„éå†å¼€é”€ï¼ˆä½†å·²é€šè¿‡ `amount > 0` æ£€æŸ¥è·³è¿‡ï¼‰
- **æœªæ¥ä¼˜åŒ–ï¼š** å¯è€ƒè™‘å®ç°æ§½ä½å›æ”¶æœºåˆ¶

### Gas Refund

âœ… **åˆ é™¤å­˜å‚¨å¯è·å¾— gas refund**
```solidity
delete userStakes[user][stakeIndex];  
// é‡Šæ”¾ 3 ä¸ªå­˜å‚¨æ§½ Ã— 15,000 gas = 45,000 gas refund
```

**æ³¨æ„ï¼š** EIP-3529 åï¼Œrefund ä¸Šé™ä¸ºäº¤æ˜“ gas çš„ 20%

---

## ğŸ“ å‡çº§è¯´æ˜

### å¯¹äºç°æœ‰éƒ¨ç½²

å¦‚æœä½ å·²ç»éƒ¨ç½²äº† v2.0ï¼š

1. **å‡çº§åˆçº¦**
   ```solidity
   // é€šè¿‡ UUPS å‡çº§
   stakingModule.upgradeToAndCall(newImplementation, "");
   ```

2. **å†å²æ•°æ®å¤„ç†**
   - âœ… ç°æœ‰æ´»è·ƒè´¨æŠ¼ä¸å—å½±å“
   - âœ… ç°æœ‰å·²èµå›è´¨æŠ¼è®°å½•ä¼šä¿ç•™ï¼ˆä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼‰
   - âš ï¸ åªæœ‰å‡çº§åæ–°èµå›çš„è´¨æŠ¼æ‰ä¼šè¢«æ¸…ç†

3. **ï¼ˆå¯é€‰ï¼‰æ‰‹åŠ¨æ¸…ç†å†å²è®°å½•**
   ```solidity
   // ç®¡ç†å‘˜å¯ä»¥é€‰æ‹©å®ç°ä¸€ä¸ªæ‰¹é‡æ¸…ç†å‡½æ•°
   // ä½†éœ€è°¨æ…ï¼Œç¡®ä¿ä¸å½±å“ç”¨æˆ·ç§¯åˆ†
   ```

---

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸï¼ˆv2.2ï¼‰
- å®ç°æ§½ä½å›æ”¶æœºåˆ¶ï¼ˆå‡å°‘ `userStakeCount`ï¼‰
- æ·»åŠ æ‰¹é‡èµå›åŠŸèƒ½ï¼ˆå‡å°‘äº¤æ˜“æ¬¡æ•°ï¼‰

### ä¸­æœŸï¼ˆv3.0ï¼‰
- è€ƒè™‘åˆ‡æ¢åˆ° Synthetix å…¨å±€çŠ¶æ€æ¨¡å¼ï¼ˆO(1) ç§¯åˆ†è®¡ç®—ï¼‰
- å®ç°ç§¯åˆ†å¿«ç…§æœºåˆ¶ï¼ˆå‡å°‘å®æ—¶è®¡ç®—ï¼‰

### é•¿æœŸ
- Layer 2 éƒ¨ç½²ï¼ˆè¿›ä¸€æ­¥é™ä½ gas æˆæœ¬ï¼‰
- é“¾ä¸‹ç´¢å¼•æœåŠ¡ï¼ˆå†å²è®°å½•æŸ¥è¯¢ï¼‰

---

## ğŸ“Š æ€»ç»“

| æŒ‡æ ‡ | æ”¹å–„ |
|------|------|
| **Gas æˆæœ¬** | âœ… -40~50% |
| **å­˜å‚¨å ç”¨** | âœ… -50% |
| **ä»£ç å¤æ‚åº¦** | âœ… ä¿æŒç®€å• |
| **å‘åå…¼å®¹** | âœ… å®Œå…¨å…¼å®¹ |
| **æµ‹è¯•è¦†ç›–** | âœ… 100% é€šè¿‡ |

**v2.1 æ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ•ˆçš„ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå»ºè®®æ‰€æœ‰ç”¨æˆ·å‡çº§ï¼** ğŸ‰

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **åˆçº¦ï¼š** `src/StakingModule.sol`
- **æµ‹è¯•ï¼š** `test/StakingModule.t.sol`
- **æ¥å£ï¼š** `src/interfaces/IPointsModule.sol`

## ğŸ”— å‚è€ƒ

- [EIP-3529: Reduction in refunds](https://eips.ethereum.org/EIPS/eip-3529)
- [Solidity Gas Optimization](https://docs.soliditylang.org/en/latest/internals/optimiser.html)
- [OpenZeppelin UUPS Proxy](https://docs.openzeppelin.com/contracts/4.x/api/proxy#UUPSUpgradeable)

---

**æ—¥æœŸï¼š** 2026-01-26  
**ä½œè€…ï¼š** Paimon Protocol Team  
**ç‰ˆæœ¬ï¼š** v2.1.0
